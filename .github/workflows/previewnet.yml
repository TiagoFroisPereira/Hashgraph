#  Required variables set by GitHub environment secrets
#
#  PREVIEWNET_ACCOUNT_NUMBER_MACOS:         Address number for MaxOS tests of account making requests (assumes Realm = 0, Shard = 0)
#  PREVIEWNET_ACCOUNT_NUMBER_UBUNTU:        Address number for Ubuntu tests
#  PREVIEWNET_ACCOUNT_NUMBER_WINDOWS:       Address number for Windows tests
#  PREVIEWNET_ACCOUNT_PRIVATE_KEY_MACOS:    Private Key for MaxOS tests of account making requests of the network, encoded in Hex
#  PREVIEWNET_ACCOUNT_PRIVATE_KEY_UBUNTU:   Private Key for Ubuntu tests
#  PREVIEWNET_ACCOUNT_PRIVATE_KEY_WINDOWS:  Private Key for Windows tests
#  PREVIEWNET_ACCOUNT_PUBLIC_KEY_MACOS:     Public Key for MaxOS tests of account making requests of the network, encoded in Hex (last 32 bytes)
#  PREVIEWNET_ACCOUNT_PUBLIC_KEY_UBUNTU:    Public Key for Ubuntu tests
#  PREVIEWNET_ACCOUNT_PUBLIC_KEY_WINDOWS:   Public Key for Windows tests
#  PREVIEWNET_MIRROR_ADDRESS:               Mirror Node DNS name, for example 'testnet.mirrornode.hedera.com'
#  PREVIEWNET_MIRROR_PORT:                  Mirror Node port number
#  PREVIEWNET_NETWORK_ADDRESS:              Test Network DNS name, for example 'testnet.hedera.com'
#  PREVIEWNET_NETWORK_PORT:                 Test Network port number
#  PREVIEWNET_SERVER_NUMBER:                Network Node Address Number receiving Network Requests (assumes Realm = 0, Shard = 0)

name: CI build on previewnet

on:
  push:
    branches: [ previewnet ]
  pull_request:
    branches: [ previewnet ]

jobs:
  build:
    environment: Previewnet
    runs-on: ${{ format('{0}-latest', matrix.os) }}
    timeout-minutes: 360
    env:
      buildConfiguration: Release
      minimumBalance: 2500 # ~2,200‚Ñè needed per test run
      DOTNET_NOLOGO: true
      PREVIEWNET_ACCOUNT_NUMBER: ${{ secrets[format('PREVIEWNET_ACCOUNT_NUMBER_{0}', matrix.os)] }}
      PREVIEWNET_ACCOUNT_PUBLIC_KEY: ${{ secrets[format('PREVIEWNET_ACCOUNT_PUBLIC_KEY_{0}', matrix.os)] }}
      PREVIEWNET_ACCOUNT_PRIVATE_KEY: ${{ secrets[format('PREVIEWNET_ACCOUNT_PRIVATE_KEY_{0}', matrix.os)] }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu, windows, macOS]

    steps:
    - name: Checkout üõéÔ∏è
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
        submodules: true # TODO: .nuget package for hedera-protobufs?

    - name: Setup .NET üë∑
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 5.0.x

    - name: Build üöÄ
      run: dotnet build --configuration ${{ env.buildConfiguration }}

    - name: Check ƒ¶ account balance üí∞
      uses: si618/hedera-check-balance@latest
      with:
        operator-id: '0.0.${{ env.PREVIEWNET_ACCOUNT_NUMBER }}'
        operator-key: ${{ env.PREVIEWNET_ACCOUNT_PRIVATE_KEY }}
        minimum-balance: ${{ env.minimumBalance }}

    - name: Test ‚úÖ
      run: dotnet test --configuration ${{ env.buildConfiguration }} --no-build --verbosity normal
      env:
        'account:number': ${{ env.PREVIEWNET_ACCOUNT_NUMBER }}
        'account:publicKey': ${{ env.PREVIEWNET_ACCOUNT_PUBLIC_KEY }}
        'account:privateKey': ${{ env.PREVIEWNET_ACCOUNT_PRIVATE_KEY }}
        'mirror:address': ${{ secrets.PREVIEWNET_MIRROR_ADDRESS }}
        'mirror:port': ${{ secrets.PREVIEWNET_MIRROR_PORT }}
        'network:address': ${{ secrets.PREVIEWNET_NETWORK_ADDRESS }}
        'network:port': ${{ secrets.PREVIEWNET_NETWORK_PORT }}
        'server:number': ${{ secrets.PREVIEWNET_SERVER_NUMBER }}
